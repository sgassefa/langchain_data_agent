intent_detection_agent:
  llm:
    model: gpt-4o-mini
    provider: openai
    api_version: 2024-12-01-preview
    temperature: 1.0
    max_tokens: 500
  system_prompt: |
    You are an intent detection assistant responsible for routing user questions to the appropriate data agent.
    ## Available Data Agents

    {agent_descriptions}

    ## Instructions

    1. Analyze the user's question to understand what data they are asking about.
    2. Match the question to the most relevant data agent based on the domain and data types.
    3. If the question is ambiguous, choose the agent most likely to have the relevant data.
    4. If no agent is a clear match, respond with "unknown".

    ## Response Format

    Respond with ONLY the agent name (e.g., "contoso_hr"). Do not include any explanation.

data_agents:
  - name: contoso_hr
    datasource:
      type: azure_sql
      server: lis-4230.database.windows.net
      database: ContosoHR
      use_aad: false
      username: dbadmin
    llm:
      model: gpt-4o-mini
      provider: openai
      api_version: 2024-12-01-preview
      temperature: 1.0
      max_tokens: 2000
    system_prompt: |
      You are an expert SQL assistant for the Contoso HR database running on Azure SQL Database.
      ## Your Role

      Generate accurate, efficient T-SQL queries based on natural language questions. You have access to employee, department, performance review, and time-off data.
      ## Database Context

      {schema_context}

      ## Examples

      {few_shot_examples}

      ## T-SQL Generation Guidelines

      1. **Use only tables and columns defined in the schema above.** Never reference tables or columns not listed.
      2. **Use T-SQL syntax.** This includes:
         - DATEADD, DATEDIFF, DATEPART for date operations
         - GETDATE(), GETUTCDATE() for current time
         - TOP instead of LIMIT for row limiting
         - NVARCHAR, INT, DECIMAL, BIT, DATE data types
      3. **Always qualify column names** with table aliases to avoid ambiguity.
      4. **Use appropriate JOINs** when combining data from multiple tables.
      5. **Include WHERE clauses** to filter data when the question implies filtering.
      6. **Use GROUP BY** for aggregations and ORDER BY for sorting results.
      7. **Use TOP N** to limit results (e.g., TOP 100) unless the user specifies otherwise.
      8. **Handle NULL values** appropriately with ISNULL or COALESCE.
      9. **Use schema-qualified names** (e.g., dbo.Employees) for all table references.

      ## Response Format

      Provide your response as JSON with two fields:
      - "sql_query": The generated T-SQL query
      - "explanation": Brief explanation of what the query does
    response_prompt: |
      You are a helpful HR analyst for Contoso.

      Given the user's question, the SQL query that was executed, and the results,
      provide a clear and concise natural language response.

      Be conversational but precise. Include relevant numbers, percentages, and insights.
      Format currency values with $ and commas. Format large numbers for readability.
      If the results are empty, explain what that means in context.

      ## Data Presentation

      When the query returns tabular data (multiple rows/columns), ALWAYS include a formatted markdown table showing the results.
      - Use proper markdown table syntax with headers
      - Align numeric columns to the right
      - Format salaries with $ and commas (e.g., $125,000.00)
      - Format dates in readable format (e.g., Dec 16, 2025)
      - Limit tables to 20 rows max; if more rows exist, show first 20 and note "... and X more rows"
      - After the table, provide a brief summary or insight about the data
    table_schemas:
      - table_name: dbo.Departments
        table_description: Company departments with budget information
        columns:
          - column_name: DepartmentID
            data_type: INT
            description: Unique department identifier
          - column_name: Name
            data_type: NVARCHAR(100)
            description: Department name
          - column_name: Budget
            data_type: DECIMAL(12,2)
            description: Annual department budget in USD
          - column_name: ManagerID
            data_type: INT
            description: Employee ID of the department manager
      - table_name: dbo.Employees
        table_description: Employee information including salary and organizational hierarchy
        columns:
          - column_name: EmployeeID
            data_type: INT
            description: Unique employee identifier
          - column_name: FirstName
            data_type: NVARCHAR(50)
            description: Employee first name
          - column_name: LastName
            data_type: NVARCHAR(50)
            description: Employee last name
          - column_name: Email
            data_type: NVARCHAR(100)
            description: Employee email address
          - column_name: DepartmentID
            data_type: INT
            description: Department the employee belongs to
          - column_name: Title
            data_type: NVARCHAR(100)
            description: Job title
          - column_name: HireDate
            data_type: DATE
            description: Date the employee was hired
          - column_name: Salary
            data_type: DECIMAL(10,2)
            description: Annual salary in USD
          - column_name: ManagerID
            data_type: INT
            description: Employee ID of the direct manager (NULL for top-level)
          - column_name: IsActive
            data_type: BIT
            description: Whether the employee is currently active (1=active, 0=inactive)
      - table_name: dbo.PerformanceReviews
        table_description: Employee performance review records
        columns:
          - column_name: ReviewID
            data_type: INT
            description: Unique review identifier
          - column_name: EmployeeID
            data_type: INT
            description: Employee being reviewed
          - column_name: ReviewDate
            data_type: DATE
            description: Date of the review
          - column_name: Rating
            data_type: INT
            description: Performance rating (1-5, where 5 is excellent)
          - column_name: ReviewerID
            data_type: INT
            description: Employee ID of the reviewer (manager)
          - column_name: Comments
            data_type: NVARCHAR(500)
            description: Review comments and feedback
      - table_name: dbo.TimeOffRequests
        table_description: Employee time-off and leave requests
        columns:
          - column_name: RequestID
            data_type: INT
            description: Unique request identifier
          - column_name: EmployeeID
            data_type: INT
            description: Employee requesting time off
          - column_name: StartDate
            data_type: DATE
            description: Start date of time off
          - column_name: EndDate
            data_type: DATE
            description: End date of time off
          - column_name: Type
            data_type: NVARCHAR(50)
            description: Type of time off
            allowed_values:
              Vacation: Paid vacation time
              Sick: Sick leave
              Personal: Personal day
              Conference: Conference or training
          - column_name: Status
            data_type: NVARCHAR(20)
            description: Request status
            allowed_values:
              Pending: Awaiting approval
              Approved: Request approved
              Denied: Request denied
          - column_name: DaysRequested
            data_type: INT
            description: Number of days requested
    few_shot_examples:
      - question: How many employees are in each department?
        answer: Engineering has 5 employees, Sales has 5 employees, Marketing has 5 employees.
        sql_query: |
          SELECT d.Name AS Department, COUNT(e.EmployeeID) AS EmployeeCount
          FROM dbo.Departments d
          LEFT JOIN dbo.Employees e ON d.DepartmentID = e.DepartmentID
          WHERE e.IsActive = 1
          GROUP BY d.DepartmentID, d.Name
          ORDER BY EmployeeCount DESC
      - question: What is the average salary by department?
        answer: R&D has the highest average salary at $127,000, followed by Finance at $101,800.
        sql_query: |
          SELECT d.Name AS Department,
                 AVG(e.Salary) AS AvgSalary,
                 MIN(e.Salary) AS MinSalary,
                 MAX(e.Salary) AS MaxSalary
          FROM dbo.Departments d
          JOIN dbo.Employees e ON d.DepartmentID = e.DepartmentID
          WHERE e.IsActive = 1
          GROUP BY d.DepartmentID, d.Name
          ORDER BY AvgSalary DESC
      - question: Who are the top performers this year?
        answer: Emily Rodriguez, Nicole Garcia, Ashley Walker, Jessica Robinson, and Benjamin Hall all received 5-star ratings in their recent reviews.
        sql_query: |
          SELECT TOP 10
            e.FirstName + ' ' + e.LastName AS EmployeeName,
            d.Name AS Department,
            e.Title,
            pr.Rating,
            pr.Comments,
            pr.ReviewDate
          FROM dbo.PerformanceReviews pr
          JOIN dbo.Employees e ON pr.EmployeeID = e.EmployeeID
          JOIN dbo.Departments d ON e.DepartmentID = d.DepartmentID
          WHERE YEAR(pr.ReviewDate) = YEAR(GETDATE())
          ORDER BY pr.Rating DESC, pr.ReviewDate DESC
      - question: Who has pending time-off requests?
        answer: 3 employees have pending vacation requests for January.
        sql_query: |
          SELECT e.FirstName + ' ' + e.LastName AS EmployeeName,
                 t.Type,
                 t.StartDate,
                 t.EndDate,
                 t.DaysRequested
          FROM dbo.TimeOffRequests t
          JOIN dbo.Employees e ON t.EmployeeID = e.EmployeeID
          WHERE t.Status = 'Pending'
          ORDER BY t.StartDate

max_retries: 3


